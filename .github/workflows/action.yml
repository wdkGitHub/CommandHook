name: "æ‰“åŒ…å‘å¸ƒç‰ˆæœ¬"
on:
    push:
        branches:
            - master
        paths:
            - gradle.properties
    workflow_dispatch:

permissions:
    contents: write
env:
    BRANCH_NAME: master

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        env:
            GIT_USER_NAME: "GitHub Actions"
        steps:
            -   name: "æ£€å‡ºä»“åº“ä»£ç "
                uses: actions/checkout@v4
                with:
                    ref: ${{ env.BRANCH_NAME }}
                    fetch-depth: 0
                    fetch-tags: false

            -   name: "æ£€æµ‹æ˜¯å¦æ‰‹åŠ¨è§¦å‘æˆ–ç‰ˆæœ¬å˜æ›´"
                id: check-trigger
                run: |
                    if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                        echo "MANUAL_TRIGGER=true" >> $GITHUB_ENV
                        echo "PLUGIN_VERSION_CHANGED=true" >> $GITHUB_ENV
                    elif git diff HEAD~1 HEAD -- gradle.properties | grep "^+plugin.version="; then
                        echo "PLUGIN_VERSION_CHANGED=true" >> $GITHUB_ENV
                        NEW_VERSION=$(git diff HEAD~1 HEAD -- gradle.properties | grep "^+plugin.version=" | cut -d= -f2 | tr -d ' \r\n')
                        echo "NEW_PLUGIN_VERSION=$NEW_VERSION" >> $GITHUB_ENV
                    else
                        echo "PLUGIN_VERSION_CHANGED=false" >> $GITHUB_ENV
                    fi

            -   name: "è®¾ç½® JDK21"
                uses: actions/setup-java@v4
                with:
                    distribution: 'temurin'
                    java-version: '21'
                    cache: 'gradle'

            -   name: "ç¼“å­˜ Gradle ä¾èµ–"
                uses: actions/cache@v3
                with:
                    path: ~/.gradle/caches
                    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                    restore-keys: |
                        ${{ runner.os }}-gradle-

            -   name: "è§£æç¯å¢ƒå˜é‡"
                id: set-env-vars
                run: |
                    export PLUGIN_NAME=$(awk -F= '/plugin.name/{print $2}' gradle.properties | tr -d ' \r\n')
                    export PLUGIN_VERSION=$(awk -F= '/plugin.version/{print $2}' gradle.properties | tr -d ' \r\n')
                    export PLUGIN_VENDOR_EMAIL=$(awk -F= '/plugin.vendor.email/{print $2}' gradle.properties | tr -d ' \r\n')
                    echo "PLUGIN_NAME=${PLUGIN_NAME}" >> $GITHUB_ENV
                    echo "PLUGIN_VERSION=${PLUGIN_VERSION}" >> $GITHUB_ENV
                    echo "PLUGIN_VENDOR_EMAIL=${PLUGIN_VENDOR_EMAIL}" >> $GITHUB_ENV
                    # åœ¨æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œè®¾ç½® NEW_PLUGIN_VERSION ç­‰äºå½“å‰ç‰ˆæœ¬
                    if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                        echo "NEW_PLUGIN_VERSION=${PLUGIN_VERSION}" >> $GITHUB_ENV
                    fi

            -   name: "æ„å»ºå’Œå‘å¸ƒæ’ä»¶"
                if: env.PLUGIN_VERSION_CHANGED == 'true'
                run: |
                    set -e
                    ./gradlew buildPlugin updatePluginXml --info --stacktrace \
                        -Purl=https://github.com/${{ github.repository }}/releases/download/v${{ env.NEW_PLUGIN_VERSION }}/${{ env.PLUGIN_NAME }}-${{ env.NEW_PLUGIN_VERSION }}.zip

            -   name: "æäº¤ç‰ˆæœ¬å˜æ›´"
                if: env.PLUGIN_VERSION_CHANGED == 'true'
                run: |
                    git config --global user.name "${{ env.GIT_USER_NAME }}"
                    git config --global user.email "${{ env.PLUGIN_VENDOR_EMAIL }}"
                    git diff --quiet || (git add . && git commit -m "ğŸ”– å‘å¸ƒç‰ˆæœ¬ ${{ env.NEW_PLUGIN_VERSION }}")

            -   name: "åˆ›å»º Git Tag"
                if: env.PLUGIN_VERSION_CHANGED == 'true'
                run: |
                    git fetch --tags
                    if git tag | grep -q "v${{ env.NEW_PLUGIN_VERSION }}"; then
                        echo "æ ‡ç­¾ v${{ env.NEW_PLUGIN_VERSION }} å·²å­˜åœ¨ï¼Œæœ¬åœ°åˆ é™¤..."
                        git tag -d "v${{ env.NEW_PLUGIN_VERSION }}"
                        git push origin --delete "v${{ env.NEW_PLUGIN_VERSION }}"
                    fi
                    git tag -a "v${{ env.NEW_PLUGIN_VERSION }}" -m "Version ${{ env.NEW_PLUGIN_VERSION }}"

            -   name: "å‘å¸ƒç‰ˆæœ¬"
                if: env.PLUGIN_VERSION_CHANGED == 'true'
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: "v${{ env.NEW_PLUGIN_VERSION }}"
                    name: "v${{ env.NEW_PLUGIN_VERSION }}"
                    body: "ğŸ”– å‘å¸ƒç‰ˆæœ¬ ${{ env.NEW_PLUGIN_VERSION }}"
                    files: build/distributions/${{ env.PLUGIN_NAME }}-${{ env.NEW_PLUGIN_VERSION }}.zip
                    prerelease: ${{ startsWith(env.NEW_PLUGIN_VERSION, 'SNAPSHOT') }}

            -   name: "æ¨é€æäº¤æˆ–æ ‡ç­¾"
                if: env.PLUGIN_VERSION_CHANGED == 'true'
                run: |
                    git push origin ${{ env.BRANCH_NAME }} --tags || echo "æ²¡æœ‰éœ€è¦æ¨é€çš„ä¿¡æ¯"
